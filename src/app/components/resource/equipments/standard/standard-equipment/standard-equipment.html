<!-- Заголовок и кнопка добавления -->
<div class="section-header">
  <h2>Стандартные образцы</h2>
  <app-button
    (click)="openDialog(StandardEquipmentDialog, 'standard-equipments')"
    [matTooltip]="'Добавить стандартный образец'"
    class="add-button">
    <mat-icon>add</mat-icon>
  </app-button>
</div>

<div class="table-controls">
  <button mat-button [matMenuTriggerFor]="columnMenu">
    <mat-icon>view_column</mat-icon>
    Колонки
  </button>
  <mat-menu #columnMenu="matMenu">
    @for (col of allColumns; track col) {
      @if (col !== 'index' && col !== 'actions') {
        <button mat-menu-item>
          <mat-checkbox
            [checked]="displayedColumns.includes(col)"
            (change)="toggleColumn(col, $event)">
            {{ getColumnLabel(col) }}
          </mat-checkbox>
        </button>
      }
    }
  </mat-menu>
</div>

<!-- Таблица -->
<table mat-table [dataSource]="info()" class="mat-elevation-z8">

  <!-- № п/п -->
  <ng-container matColumnDef="index">
    <th mat-header-cell *matHeaderCellDef>№</th>
    <td mat-cell *matCellDef="let _; let i = index" class="data-cell">
      {{ i + 1 }}
    </td>
  </ng-container>

  <!-- Тип стандартного образца -->
  <ng-container matColumnDef="standardTypeId">
    <th mat-header-cell [matTooltip]="'Тип стандартного образца (ГСО, СО и т.д.)'" *matHeaderCellDef>
      Категория СО
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      @if (getTypeLabel(item.standardTypeId); as label) {
        {{ label }}
      } @else {
        {{ item.standardTypeId || '—' }}
      }
    </td>
  </ng-container>

  <!-- Наименование -->
  <ng-container matColumnDef="name">
    <th mat-header-cell [matTooltip]="'Наименование стандартного образца'" *matHeaderCellDef>
      Наименование
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.name || '—' }}
    </td>
  </ng-container>

  <!-- Изготовитель -->
  <ng-container matColumnDef="producer">
    <th mat-header-cell [matTooltip]="'Организация-изготовитель'" *matHeaderCellDef>
      Изготовитель
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.producer || '—' }}
    </td>
  </ng-container>

  <!-- Номер -->
  <ng-container matColumnDef="number">
    <th mat-header-cell *matHeaderCellDef>
      Номер СО
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.number || '—' }}
    </td>
  </ng-container>

  <!-- Назначение -->
  <ng-container matColumnDef="purpose">
    <th mat-header-cell [matTooltip]="'Назначение (например, градуировка, контроль точности)'" *matHeaderCellDef>
      Назначение
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.purpose || '—' }}
    </td>
  </ng-container>

  <!-- Сведения -->
  <ng-container matColumnDef="information">
    <th mat-header-cell [matTooltip]="'Дополнительные сведения (в том числе из Федерального информационного фонда по обеспечению единства измерений на ГСО)'" *matHeaderCellDef>
      Дополнительные сведения
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.information || '—' }}
    </td>
  </ng-container>

  <!-- Условия применения -->
  <ng-container matColumnDef="termsOfUse">
    <th mat-header-cell [matTooltip]="'Нормативный документ(НД), порядок и условия применения'" *matHeaderCellDef>
      Нормативный документ(НД)
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.termsOfUse || '—' }}
    </td>
  </ng-container>

  <!-- Дата изготовления -->
  <ng-container matColumnDef="produceDate">
    <th mat-header-cell [matTooltip]="'Дата изготовления стандартного образца'" *matHeaderCellDef>
      Дата изготовления
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.produceDate ? (item.produceDate | date) : '—' }}
    </td>
  </ng-container>

  <!-- Срок годности -->
  <ng-container matColumnDef="expirationDate">
    <th mat-header-cell [matTooltip]="'Срок годности до'" *matHeaderCellDef>
      Срок годности
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.expirationDate ? (item.expirationDate | date) : '—' }}
    </td>
  </ng-container>

  <!-- 1. Наименование и аттестованное значение -->
  <ng-container matColumnDef="characteristicNameValue">
    <th mat-header-cell [matTooltip]="'Наименование и аттестованное значение метрологической характеристики'" *matHeaderCellDef>
      Наименование и аттестованное значение
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      @if (Array.isArray(item.characteristics) && item.characteristics.length > 0) {
        <div class="characteristics-stack">
          @for (char of item.characteristics; track $index) {
            <div>
              <strong>{{ char.name }}</strong>:
                {{ char.value }} {{ char.unit || '' }}
            </div>
          }
        </div>
      } @else {
        —
      }
    </td>
  </ng-container>

  <!-- 2. Неопределённость -->
  <ng-container matColumnDef="characteristicUncertainty">
    <th mat-header-cell [matTooltip]="'Неопределённость и (или) характеристика погрешности аттестованного значения'" *matHeaderCellDef>
      Неопределённость и (или) характеристика погрешности
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      @if (Array.isArray(item.characteristics) && item.characteristics.length > 0) {
        <div class="characteristics-stack">
          @for (char of item.characteristics; track $index) {
            @if (char.uncertainty != null) {
              <div>±{{ char.uncertainty }} {{ char.unitUncertainty || char.unit || '' }}</div>
            } @else {
              <div>—</div>
            }
          }
        </div>
      } @else {
        —
      }
    </td>
  </ng-container>


  <!-- Действия -->
  <ng-container matColumnDef="actions">
    <th mat-header-cell *matHeaderCellDef>Действия</th>
    <td mat-cell *matCellDef="let item">
      <button
        mat-icon-button
        [matTooltip]="'Редактировать'"
        (click)="openDialog(StandardEquipmentDialog, 'standard-equipments', item)">
        <mat-icon>edit</mat-icon>
      </button>
      <button
        mat-icon-button
        [matTooltip]="'Удалить'"
        (click)="delete(item.id, 'standard-equipments')">
        <mat-icon>delete</mat-icon>
      </button>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
</table>
