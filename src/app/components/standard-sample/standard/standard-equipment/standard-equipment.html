<!-- Заголовок и кнопка добавления -->
<div class="section-header">
  <h2>Стандартные образцы</h2>
  <mat-form-field appearance="outline" class="view-mode-select">
    <mat-label>Просмотр</mat-label>
    <mat-select [(value)]="viewMode">
      <mat-option value="table">Таблица</mat-option>
      <mat-option value="expiration-chart">Сроки годности</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="outline" class="view-mode-select">
    <mat-label>Просмотр СО</mat-label>
    <mat-select [(value)]="canUse">
      <mat-option value="all">Все реактивы</mat-option>
      <mat-option value="isCanUse">Можно использовать</mat-option>
      <mat-option value="isCanNotUse">Нельзя использовать</mat-option>
    </mat-select>
  </mat-form-field>
</div>

@if (viewMode == 'table') {
  <div class="table-actions">
    <button mat-button [matMenuTriggerFor]="columnMenu">
      <mat-icon>view_column</mat-icon>
      Колонки
    </button>
    <mat-menu #columnMenu="matMenu">
      @for (col of allColumns; track col) {
        @if (col !== 'index' && col !== 'actions') {
          <button mat-menu-item>
            <mat-checkbox
              [checked]="displayedColumns.includes(col)"
              (change)="toggleColumn(col, $event)">
              {{ getColumnLabel(col) }}
            </mat-checkbox>
          </button>
        }
      }
    </mat-menu>

    <button
      (click)="openDialog(StandardEquipmentDialog, 'standard-samples', Mode.CREATE)"
      [matTooltip]="'Добавить реактив'"
      class="table-add-button">
      <mat-icon>add</mat-icon>
    </button>
  </div>

  <!-- Таблица -->
  <table mat-table [dataSource]="filterInfo(info(), canUse)" class="mat-elevation-z8">

    <!-- № п/п -->
    <ng-container matColumnDef="index">
      <th mat-header-cell *matHeaderCellDef>№</th>
      <td mat-cell *matCellDef="let _; let i = index" class="data-cell">
        {{ i + 1 }}
      </td>
    </ng-container>

    <!-- Тип стандартного образца -->
    <ng-container matColumnDef="standardTypeId">
      <th mat-header-cell [matTooltip]="'Тип стандартного образца (ГСО, СО и т.д.)'" *matHeaderCellDef>
        Категория СО
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        @if (getTypeLabel(item.standardTypeId); as label) {
          {{ label }}
        } @else {
          {{ item.standardTypeId || '—' }}
        }
      </td>
    </ng-container>

    <!-- Наименование -->
    <ng-container matColumnDef="name">
      <th mat-header-cell [matTooltip]="'Наименование стандартного образца'" *matHeaderCellDef>
        Наименование
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.name || '—' }}
      </td>
    </ng-container>

    <!-- Изготовитель -->
    <ng-container matColumnDef="producer">
      <th mat-header-cell [matTooltip]="'Организация-изготовитель'" *matHeaderCellDef>
        Изготовитель
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.producer || '—' }}
      </td>
    </ng-container>

    <!-- Номер -->
    <ng-container matColumnDef="number">
      <th mat-header-cell *matHeaderCellDef>
        Номер СО
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.number || '—' }}
      </td>
    </ng-container>

    <!-- Назначение -->
    <ng-container matColumnDef="purpose">
      <th mat-header-cell [matTooltip]="'Назначение (например, градуировка, контроль точности)'" *matHeaderCellDef>
        Назначение
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.purpose || '—' }}
      </td>
    </ng-container>

    <!-- Сведения -->
    <ng-container matColumnDef="information">
      <th mat-header-cell
          [matTooltip]="'Дополнительные сведения (в том числе из Федерального информационного фонда по обеспечению единства измерений на ГСО)'"
          *matHeaderCellDef>
        Дополнительные сведения
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.information || '—' }}
      </td>
    </ng-container>

    <!-- Условия применения -->
    <ng-container matColumnDef="termsOfUse">
      <th mat-header-cell [matTooltip]="'Нормативный документ(НД), порядок и условия применения'" *matHeaderCellDef>
        Нормативный документ(НД)
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.termsOfUse || '—' }}
      </td>
    </ng-container>

    <!-- Дата изготовления -->
    <ng-container matColumnDef="produceDate">
      <th mat-header-cell [matTooltip]="'Дата изготовления стандартного образца'" *matHeaderCellDef>
        Дата изготовления
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.produceDate ? (item.produceDate | date) : '—' }}
      </td>
    </ng-container>

    <!-- Срок годности -->
    <ng-container matColumnDef="expirationDate">
      <th mat-header-cell [matTooltip]="'Срок годности до'" *matHeaderCellDef>
        Срок годности
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.expirationDate ? (item.expirationDate | date) : '—' }}
      </td>
    </ng-container>

    <!-- 1. Наименование и аттестованное значение -->
    <ng-container matColumnDef="characteristicNameValue">
      <th mat-header-cell [matTooltip]="'Наименование и аттестованное значение метрологической характеристики'"
          *matHeaderCellDef>
        Наименование и аттестованное значение
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        @if (Array.isArray(item.characteristics) && item.characteristics.length > 0) {
          <div class="characteristics-stack">
            @for (char of item.characteristics; track $index) {
              <div>
                <strong>{{ char.name }}</strong>:
                {{ char.value }} {{ char.unit || '' }}
              </div>
            }
          </div>
        } @else {
          —
        }
      </td>
    </ng-container>

    <!-- 2. Неопределённость -->
    <ng-container matColumnDef="characteristicUncertainty">
      <th mat-header-cell [matTooltip]="'Неопределённость и (или) характеристика погрешности аттестованного значения'"
          *matHeaderCellDef>
        Неопределённость и (или) характеристика погрешности
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        @if (Array.isArray(item.characteristics) && item.characteristics.length > 0) {
          <div class="characteristics-stack">
            @for (char of item.characteristics; track $index) {
              @if (char.uncertainty != null) {
                <div>±{{ char.uncertainty }} {{ char.unitUncertainty || char.unit || '' }}</div>
              } @else {
                <div>—</div>
              }
            }
          </div>
        } @else {
          —
        }
      </td>
    </ng-container>

    <!-- Действия → Выпадающее меню -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Действия</th>
      <td mat-cell *matCellDef="let item">
        <button
          mat-icon-button
          [matMenuTriggerFor]="itemMenu"
          [matTooltip]="'Действия'"
          aria-label="Действия">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #itemMenu="matMenu">
          <!-- Редактировать -->
          <button
            mat-menu-item
            (click)="openDialog(StandardEquipmentDialog, 'standard-samples', Mode.EDIT, item)">
            <mat-icon>edit</mat-icon>
            <span>Редактировать</span>
          </button>

          <button
            mat-menu-item
            (click)="openDialog(StandardEquipmentDialog, 'standard-samples', Mode.CREATE_AS_TEMPLATE, item)">
            <mat-icon>content_copy</mat-icon>
            <span>Создать на основе</span>
          </button>

          <!-- Взять реактив (только если consumable = true) -->
          @if (item.consumable && item.canUse) {
            <button
              mat-menu-item
              (click)="openDialogExpenditure('standard-samples', item)">
              <mat-icon>remove_shopping_cart</mat-icon>
              <span>Взять реактив</span>
            </button>

            <button
              mat-menu-item
              (click)="openHistoryExpenditure(item)">
              <mat-icon>receipt_long</mat-icon>
              <span>История расхода</span>
            </button>
          }

          <!-- Удалить -->
          <button
            mat-menu-item
            (click)="delete(item.id, 'standard-samples')">
            <mat-icon>{{ item.canUse ? 'move_to_inbox' : 'delete' }}</mat-icon>
            <span>{{ item.canUse ? 'Убрать в архив' : 'Удалить' }} </span>
          </button>

          <!--          todo нужно потом добавить возможность возвращать из архива-->
        </mat-menu>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <mat-paginator
    [length]="totalItems()"
    [pageIndex]="currentPage()"
    [pageSize]="pageSize()"
    [pageSizeOptions]="[5, 10, 20]"
    (page)="onPageChange($event)"
    aria-label="Пагинация транзакций"
  >
  </mat-paginator>

} @else if (viewMode == 'expiration-chart') {
  <app-reagent-expiration [info]="filterInfo(info(), canUse)"></app-reagent-expiration>
}
