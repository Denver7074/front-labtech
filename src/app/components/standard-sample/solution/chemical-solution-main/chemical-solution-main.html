<!-- Заголовок и кнопка добавления -->
<div class="section-header">
  <h2>Стандартные образцы</h2>
  <mat-form-field appearance="outline" class="view-mode-select">
    <mat-label>Просмотр</mat-label>
    <mat-select [(value)]="viewMode">
      <mat-option value="table">Таблица</mat-option>
      <mat-option value="expiration-chart">Сроки годности</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="outline" class="view-mode-select">
    <mat-label>Просмотр СО</mat-label>
    <mat-select [(value)]="canUse">
      <mat-option value="all">Все реактивы</mat-option>
      <mat-option value="isCanUse">Можно использовать</mat-option>
      <mat-option value="isCanNotUse">Нельзя использовать</mat-option>
    </mat-select>
  </mat-form-field>
</div>

@if (viewMode == 'table') {
  <div class="table-actions">
    <button mat-button [matMenuTriggerFor]="columnMenu">
      <mat-icon>view_column</mat-icon>
      Колонки
    </button>
    <mat-menu #columnMenu="matMenu">
      @for (col of allColumns; track col) {
        @if (col !== 'index' && col !== 'actions') {
          <button mat-menu-item>
            <mat-checkbox
              [checked]="displayedColumns.includes(col)"
              (change)="toggleColumn(col, $event)">
              {{ getColumnLabel(col) }}
            </mat-checkbox>
          </button>
        }
      }
    </mat-menu>

    <button
      (click)="openDialog(ChemicalSolutionDialog, 'standard-samples', Mode.CREATE)"
      [matTooltip]="'Добавить реактив'"
      class="table-add-button">
      <mat-icon>add</mat-icon>
    </button>
  </div>

  <!-- Таблица -->
  <table mat-table [dataSource]="filterInfo(info(), canUse)" class="mat-elevation-z8">

    <!-- № п/п -->
    <ng-container matColumnDef="index">
      <th mat-header-cell *matHeaderCellDef>№</th>
      <td mat-cell *matCellDef="let _; let i = index" class="data-cell">
        {{ i + 1 }}
      </td>
    </ng-container>

    <!-- Наименование -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Наименование</th>
      <td mat-cell *matCellDef="let item">
        {{ item.name || '—' }}
      </td>
    </ng-container>

    <!-- Описание -->
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef>Описание</th>
      <td mat-cell *matCellDef="let item">
        {{ item.description || '—' }}
      </td>
    </ng-container>

    <!-- Посуда -->
    <ng-container matColumnDef="dishes">
      <th mat-header-cell *matHeaderCellDef>Посуда</th>
      <td mat-cell *matCellDef="let item">
        {{ item.dishes || '—' }}
      </td>
    </ng-container>

    <!-- Нормативный документ -->
    <ng-container matColumnDef="termsOfUse">
      <th mat-header-cell *matHeaderCellDef>Нормативный документ (НД)</th>
      <td mat-cell *matCellDef="let item">
        {{ item.termsOfUse || '—' }}
      </td>
    </ng-container>

    <!-- Условия хранения -->
    <ng-container matColumnDef="conditions">
      <th mat-header-cell *matHeaderCellDef>Условия хранения</th>
      <td mat-cell *matCellDef="let item">
        {{ item.conditions || '—' }}
      </td>
    </ng-container>

    <!-- Единица измерения -->
    <ng-container matColumnDef="unit">
      <th mat-header-cell *matHeaderCellDef>Ед. изм.</th>
      <td mat-cell *matCellDef="let item">
        {{ item.unit || '—' }}
      </td>
    </ng-container>

    <!-- Дата приготовления -->
    <ng-container matColumnDef="createdSolution">
      <th mat-header-cell *matHeaderCellDef>Дата приготовления</th>
      <td mat-cell *matCellDef="let item">
        {{ item.createdSolution ? (item.createdSolution | date) : '—' }}
      </td>
    </ng-container>

    <!-- Срок годности раствора -->
    <ng-container matColumnDef="expirationSolution">
      <th mat-header-cell *matHeaderCellDef>Срок годности раствора</th>
      <td mat-cell *matCellDef="let item">
        {{ item.expirationSolution ? (item.expirationSolution | date) : '—' }}
      </td>
    </ng-container>

    <!-- Начальное количество -->
    <ng-container matColumnDef="initialQuantity">
      <th mat-header-cell *matHeaderCellDef>Начальное количество</th>
      <td mat-cell *matCellDef="let item">
        {{ item.initialQuantity ? (item.initialQuantity + ' ' + item.unit) : '—' }}
      </td>
    </ng-container>

    <!-- Остаток -->
    <ng-container matColumnDef="remains">
      <th mat-header-cell *matHeaderCellDef>Остаток</th>
      <td mat-cell *matCellDef="let item">
        {{ item.remains ? (item.remains + ' ' + item.unit) : '—' }}
      </td>
    </ng-container>

    <!-- Действия → Выпадающее меню -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Действия</th>
      <td mat-cell *matCellDef="let item">
        <button
          mat-icon-button
          [matMenuTriggerFor]="itemMenu"
          [matTooltip]="'Действия'"
          aria-label="Действия">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #itemMenu="matMenu">
          <!-- Редактировать -->
          <button
            mat-menu-item
            (click)="openDialog(ChemicalSolutionDialog, 'chemical-solution', Mode.EDIT, item)">
            <mat-icon>edit</mat-icon>
            <span>Редактировать</span>
          </button>

          <button
            mat-menu-item
            (click)="openDialog(ChemicalSolutionDialog, 'chemical-solution', Mode.CREATE_AS_TEMPLATE, item)">
            <mat-icon>content_copy</mat-icon>
            <span>Создать на основе</span>
          </button>

          <!-- Взять реактив (только если consumable = true) -->
          @if (item.consumable && item.canUse) {
            <button
              mat-menu-item
              (click)="openDialogExpenditure('chemical-solution', item)">
              <mat-icon>remove_shopping_cart</mat-icon>
              <span>Взять реактив</span>
            </button>

            <button
              mat-menu-item
              (click)="openHistoryExpenditure(item)">
              <mat-icon>receipt_long</mat-icon>
              <span>История расхода</span>
            </button>
          }

          <!-- Удалить -->
          <button
            mat-menu-item
            (click)="delete(item.id, 'chemical-solution')">
            <mat-icon>{{ item.canUse ? 'move_to_inbox' : 'delete' }}</mat-icon>
            <span>{{ item.canUse ? 'Убрать в архив' : 'Удалить' }} </span>
          </button>

          <!--          todo нужно потом добавить возможность возвращать из архива-->
        </mat-menu>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <mat-paginator
    [length]="totalItems()"
    [pageIndex]="currentPage()"
    [pageSize]="pageSize()"
    [pageSizeOptions]="[5, 10, 20]"
    (page)="onPageChange($event)"
    aria-label="Пагинация транзакций"
  >
  </mat-paginator>

} @else if (viewMode == 'expiration-chart') {
  <app-reagent-expiration [info]="filterInfo(info(), canUse)"></app-reagent-expiration>
}
