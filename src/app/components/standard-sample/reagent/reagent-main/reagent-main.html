<!-- Заголовок и кнопка добавления -->
<div class="section-header">
  <h2>Реактивы</h2>
  <mat-form-field appearance="outline" class="view-mode-select">
    <mat-label>Просмотр</mat-label>
    <mat-select [(value)]="viewMode">
      <mat-option value="table">Таблица</mat-option>
      <mat-option value="expiration-chart">Сроки годности</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="outline" class="view-mode-select">
    <mat-label>Просмотр</mat-label>
    <mat-select [(value)]="canUse">
      <mat-option value="all">Все реактивы</mat-option>
      <mat-option value="isCanUse">Можно использовать</mat-option>
      <mat-option value="isCanNotUse">Нельзя использовать</mat-option>
    </mat-select>
  </mat-form-field>
</div>

@if (viewMode == 'table') {
  <div class="table-actions">
    <button mat-button [matMenuTriggerFor]="columnMenu">
      <mat-icon>view_column</mat-icon>
      Колонки
    </button>
    <mat-menu #columnMenu="matMenu">
      @for (col of getAllColumns(); track col) {
        @if (col !== 'index' && col !== 'actions') {
          <button mat-menu-item>
            <mat-checkbox
              [checked]="displayedColumns.includes(col)"
              (change)="toggleColumn(col, $event)">
              {{ getColumnLabel(col) }}
            </mat-checkbox>
          </button>
        }
      }
    </mat-menu>

    <button
      (click)="openDialog(ReagentDialog, Mode.CREATE)"
      [matTooltip]="'Добавить реактив'"
      class="table-add-button">
      <mat-icon>add</mat-icon>
    </button>
  </div>

  <!-- Таблица -->
  <table mat-table [dataSource]="filterInfo(info(), canUse)" class="mat-elevation-z8">

    <!-- № п/п -->
    <ng-container matColumnDef="index">
      <th mat-header-cell *matHeaderCellDef>№</th>
      <td mat-cell *matCellDef="let _; let i = index" class="data-cell">
        {{ i + 1 }}
      </td>
    </ng-container>

    <!-- Объединённая колонка: Наименование + Категория СО -->
    <ng-container matColumnDef="name">
      <th mat-header-cell
          [matTooltip]="'Наименование, номер'"
          *matHeaderCellDef>
        Наименование, номер реактива
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.name }}, {{ item.number }}
      </td>
    </ng-container>

    <!-- Изготовитель и дата изготовления -->
    <ng-container matColumnDef="producer">
      <th mat-header-cell
          [matTooltip]="'Организация-изготовитель и дата выпуска стандартного образца'"
          *matHeaderCellDef>
        Изготовитель и дата выпуска
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.producer }}
        @if (item.produceDate) {
          от {{ item.produceDate | date:'dd.MM.yyyy' }}
        }
      </td>
    </ng-container>

    <ng-container matColumnDef="purity">
      <th mat-header-cell *matHeaderCellDef>
        Степень чистоты
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ getPurity(item.purityTypeId, item.purityValue) }}
      </td>
    </ng-container>

    <!-- Условия применения -->
    <ng-container matColumnDef="termsOfUse">
      <th mat-header-cell [matTooltip]="'Условия применения'" *matHeaderCellDef>
        Условия применения
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.termsOfUse | empty }}
      </td>
    </ng-container>

    <!-- Нормативные документы -->
    <ng-container matColumnDef="regulatoryDocuments">
      <th mat-header-cell [matTooltip]="'Методики измерения'" *matHeaderCellDef>
        Методики измерения
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        @if (item.regulatoryDocuments?.length; as count) {
          <div class="documents-list">
            @for (docId of item.regulatoryDocuments; track docId) {
              <span class="document-item">{{ getTypeValue(docId, 'regulatory-documents') }}</span>
            }
          </div>
        } @else {
          —
        }
      </td>
    </ng-container>

    <!-- Право владения -->
    <ng-container matColumnDef="ownership">
      <th mat-header-cell
          [matTooltip]="'Право собственности или иное законное основание, предусматривающее право владения и пользования (реквизиты подтверждающих документов)'"
          *matHeaderCellDef>
        Право владения
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell compact-ownership">
        @if (item.contract; as c) {
          <div class="ownership-line">
            @if (c.contractNumber) {
              {{ c.contractNumber }}
            }
            @if (c.contractDate) {
              от {{ c.contractDate | date:'dd.MM.yyyy' }}
            }
            @if (!c.isOwn && c.endAt) {
              <span class="period">({{ c.contractDate | date:'dd.MM.yyyy' }}–{{ c.endAt | date:'dd.MM.yyyy' }})</span>
            }
            @if (c.isOwn) {
              <span class="badge">собственность</span>
            } @else {
              <span class="badge">аренда</span>
            }
          </div>
        } @else {
          —
        }
      </td>
    </ng-container>

    <!-- Действия → Выпадающее меню -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let item">
        <button
          mat-icon-button
          [matMenuTriggerFor]="itemMenu"
          [matTooltip]="'Действия'"
          aria-label="Действия">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #itemMenu="matMenu">
          <!-- Редактировать -->
          <button
            mat-menu-item
            (click)="openDialog(ReagentDialog, Mode.EDIT, item)">
            <mat-icon>edit</mat-icon>
            <span>Редактировать</span>
          </button>

          <button
            mat-menu-item
            (click)="openDialog(ReagentDialog, Mode.CREATE_AS_TEMPLATE, item)">
            <mat-icon>content_copy</mat-icon>
            <span>Создать на основе</span>
          </button>

          @if (item.canUse) {
            <button
              mat-menu-item
              (click)="openDialogExpenditure(ReagentExpenditureDialog, item, Mode.CREATE)">
              <mat-icon>remove_shopping_cart</mat-icon>
              <span>Взять реактив</span>
            </button>
          }

          <button
            mat-menu-item
            (click)="openDialogExpenditure(ReagentHistoryExpenditure, item, Mode.VIEW)">
            <mat-icon>receipt_long</mat-icon>
            <span>История расхода</span>
          </button>

          <!-- Удалить -->
          <button
            mat-menu-item
            (click)="delete(getPathDelete(item.id))">
            <mat-icon>{{ item.canUse ? 'move_to_inbox' : 'delete' }}</mat-icon>
            <span>{{ item.canUse ? 'Убрать в архив' : 'Удалить' }} </span>
          </button>
        </mat-menu>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
} @else if (viewMode == 'expiration-chart') {
  <app-reagent-expiration [info]="filterInfo(info(), canUse)"></app-reagent-expiration>
}

<mat-paginator
  [length]="totalItems()"
  [pageIndex]="currentPage()"
  [pageSize]="pageSize()"
  [pageSizeOptions]="[5, 10, 20]"
  (page)="onPageChange($event)"
  aria-label="Пагинация транзакций"
>
</mat-paginator>
