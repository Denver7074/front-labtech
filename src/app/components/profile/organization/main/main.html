@if (isLoading()) {
  <app-loader>Загрузка данных профиля...</app-loader>
} @else {
  <div class="profile-layout">
    <!-- Боковая панель с основной информацией -->
    <aside class="profile-sidebar">
      <div>
        <div class="sidebar-section">
          <div class="avatar-container">
            @if (info()?.logoUrl) {
              <img [src]="info()?.logoUrl" alt="Аватар" class="avatar" />
            } @else {
              <div class="avatar-initials">{{ info()?.fullName }}</div>
            }
          </div>
          <div class="grid-3">
            <h3>Основная информация</h3>
            <button
              mat-icon-button
              class="add-button"
              [matTooltip]="
                info()
                  ? 'Редактировать информацию об организации'
                  : 'Добавить информацию об организации'
              "
              (click)="openGeneralDialog(OrganizationDialog, info(), false)"
            >
              <mat-icon>{{ info() ? 'edit' : 'add' }}</mat-icon>
            </button>

            @if (info()) {
              <button
                mat-icon-button
                class="add-button"
                matTooltip="Просмотреть полную карточку организации"
                (click)="openGeneralDialog(OrganizationDialog, info(), true)"
              >
                <mat-icon>help_outline</mat-icon>
              </button>
            }
          </div>
          <div class="info-list">
            <div class="info-item">
              <span class="info-label">Название компании</span>
              <span class="info-value">{{ info()?.fullName }}</span>
            </div>
            @if (info()?.shortName) {
              <div class="info-item">
                <span class="info-label">Сокращённое название</span>
                <span class="info-value">{{ info()?.shortName }}</span>
              </div>
            }

            <!-- Адреса -->
            <div class="info-item">
              <span class="info-label">Адрес регистрации</span>
              <span class="info-value">{{ info()?.registrationAddress }}</span>
            </div>
            @if (info()?.actualAddress && info()?.actualAddress !== info()?.registrationAddress) {
              <div class="info-item">
                <span class="info-label">Фактический адрес</span>
                <span class="info-value">{{ info()?.actualAddress }}</span>
              </div>
            }

          </div>
        </div>

        <div class="info-list"></div>

        <!-- Контакты -->
        @if (info()) {
          <mat-accordion class="contact-accordion">
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>contacts</mat-icon>
                  <span>Контактная информация</span>
                </mat-panel-title>
                <button
                  mat-icon-button
                  class="add-button"
                  [matTooltip]="'Добавить контакт'"
                  (click)="openDialog(ContactDialog, 'contacts')"
                >
                  <mat-icon>add</mat-icon>
                </button>
              </mat-expansion-panel-header>

              @if (info()?.contacts?.length) {
                <div class="contacts-grid">
                  @for (contact of info()!.contacts; track contact.id) {
                    <div class="contact-card">
                      <button
                        mat-icon-button
                        [matTooltip]="'Удалить контакт'"
                        (click)="delete(contact.id, 'contacts')"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        [matTooltip]="'Редактировать'"
                        (click)="openDialog(ContactDialog, 'contacts', contact)"
                      >
                        <mat-icon>edit</mat-icon>
                      </button>
                      <div class="contact-header">
                        <mat-label>
                          {{ valueType()!.get('contact-type')?.get(contact.contactTypeId) || '—' }}:
                        </mat-label>
                      </div>
                      <div class="contact-body">
                        <a class="contact-link">{{ contact.value }}</a>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-state">
                  <mat-icon>contact_mail</mat-icon>
                  <p>Контактная информация не указана</p>
                </div>
              }
            </mat-expansion-panel>
          </mat-accordion>
        }
      </div>
    </aside>

    <!-- Вкладки (подразделения и др.) -->
    @if (info()) {
      <mat-tab-group class="profile-tabs" animationDuration="300">
        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>location_on</mat-icon>
              <span>Подразделение</span>
              @if (info()?.parts?.length) {
                <span class="tab-badge">{{ info()?.parts!.length }}</span>
              }
              <button
                mat-icon-button
                class="add-button ml-10"
                [matTooltip]="'Добавить подразделение'"
                (click)="openDialog(PartDialog, 'parts')"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </ng-template>

          <div class="tab-content">
            @if (info()?.parts?.length) {
              <div class="tab-list">
                @for (part of info()!.parts; track part.id) {
                  <div class="tab-card">
                    <div class="card-actions">
                      <button
                        mat-icon-button
                        [matTooltip]="'Перейти в подразделение'"
                        (click)="goPageOrganizationPart(part)"
                      >
                        <mat-icon>open_in_new</mat-icon>
                      </button>

                      <button
                        mat-icon-button
                        [matTooltip]="'Редактировать подразделение'"
                        (click)="openDialog(PartDialog, 'parts', part)"
                      >
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        [matTooltip]="'Удалить подразделение'"
                        (click)="delete(part.id, 'parts')"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>

                    <div class="card-header">
                      <h3>
                        <mat-icon>domain</mat-icon>
                        {{ part.name }}
                      </h3>
                      <p class="part-type">
                        <mat-icon>category</mat-icon>
                        Тип:
                        {{ valueType()!.get('organization-type')?.get(part!.organizationTypeId) || '—' }}
                      </p>
                    </div>

                    <div class="part-body">
                      @if (part.registrationNumber) {
                        <p>
                          <mat-icon>badge</mat-icon>
                          <strong>Номер аккредитации:</strong>
                          @if (part.accreditationLink) {
                            <a
                              [href]="part.accreditationLink"
                              target="_blank"
                              rel="noopener"
                            >
                            {{ part.registrationNumber }}
                          </a>
                          } @else {
                            {{ part.registrationNumber }}
                          }
                        </p>
                      }

                      <p>
                        <mat-icon>person</mat-icon>
                        <strong>Руководитель:</strong> {{ part.headOfPart }}
                      </p>
                      <p>
                        <mat-icon>work</mat-icon>
                        <strong>Должность руководителя:</strong> {{ part.headPosition }}
                      </p>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-state">
                <mat-icon>domain_disabled</mat-icon>
                <p>Подразделения организации не указаны</p>
              </div>
            }
          </div>
        </mat-tab>
      </mat-tab-group>
    }
  </div>
}
