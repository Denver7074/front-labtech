<div class="section-header">
  <h2>Испытательное оборудование</h2>
  <mat-form-field appearance="outline" class="view-mode-select">
    <mat-label>Просмотр</mat-label>
    <mat-select [(value)]="viewMode">
      <mat-option value="table">Таблица</mat-option>
      <mat-option value="attestation-chart">График аттестации</mat-option>
      <mat-option value="maintenance-chart">График технического обслуживания</mat-option>
    </mat-select>
  </mat-form-field>
</div>

@if (viewMode == 'table') {
  <div class="table-actions">

    <button mat-button [matMenuTriggerFor]="columnMenu">
      <mat-icon>view_column</mat-icon>
      Колонки
    </button>
    <mat-menu #columnMenu="matMenu">
      @for (col of allColumns; track col) {
        @if (col !== 'index' && col !== 'actions') {
          <button mat-menu-item>
            <mat-checkbox
              [checked]="displayedColumns.includes(col)"
              (change)="toggleColumn(col, $event)">
              {{ getColumnLabel(col) }}
            </mat-checkbox>
          </button>
        }
      }
    </mat-menu>

    <button
      (click)="openDialog(TestEquipmentDialog, 'test-equipments', Mode.CREATE)"
      [matTooltip]="'Добавить оборудование'"
      class="table-add-button">
      <mat-icon>add</mat-icon>
    </button>
  </div>

  <!-- Таблица -->
  <table mat-table [dataSource]="info()" class="mat-elevation-z8">

    <!-- № п/п -->
    <ng-container matColumnDef="index">
      <th mat-header-cell *matHeaderCellDef>№</th>
      <td mat-cell *matCellDef="let _; let i = index" class="data-cell">
        {{ i + 1 }}
      </td>
    </ng-container>

    <!-- Наименование -->
    <ng-container matColumnDef="name">
      <th mat-header-cell [matTooltip]="'Наименование испытательного оборудования, тип (марка)'" *matHeaderCellDef>
        Наименование
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.name || '—' }}
      </td>
    </ng-container>

    <!-- Изготовитель -->
    <ng-container matColumnDef="producer">
      <th mat-header-cell
          [matTooltip]="'Страна, наименование организации, год выпуска'"
          *matHeaderCellDef>
        Изготовитель
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        @if (item.producer || item.produceYear) {
          <div>
            <div>{{ item.producer || '—' }}</div>
            @if (item.produceYear) {
              <small>Год выпуска: {{ item.produceYear }}</small>
            }
          </div>
        } @else {
          <span>—</span>
        }
      </td>
    </ng-container>

    <!-- Год ввода в эксплуатацию -->
    <ng-container matColumnDef="yearOfCommissioning">
      <th mat-header-cell
          [matTooltip]="'Год ввода в эксплуатацию'"
          *matHeaderCellDef>
        Ввод в эксплуатацию
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.yearOfCommissioning || '—' }}
      </td>
    </ng-container>

    <!-- Номера (заводской / инвентарный) -->
    <ng-container matColumnDef="numbers">
      <th mat-header-cell
          [matTooltip]="'Заводской номер (при наличии), инвентарный номер или другая уникальная идентификация'"
          *matHeaderCellDef>
        Уникальная идентификация
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        <div>
          @if (item.produceNumber) {
            <div>Заводской: {{ item.produceNumber }}</div>
          }
          @if (item.uniqueNumber) {
            <div>Инвентарный: {{ item.uniqueNumber }}</div>
          }
          @if (!item.produceNumber && !item.uniqueNumber) {
            <span>—</span>
          }
        </div>
      </td>
    </ng-container>

    <!-- Тип измерений -->
    <ng-container matColumnDef="measurementType">
      <th mat-header-cell
          [matTooltip]="'Наименование видов испытаний и/или определяемых характеристик (параметров) продукции'"
          *matHeaderCellDef>
        Наименование видов испытаний
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.measurementType || '—' }}
      </td>
    </ng-container>

    <!-- Группа измерений -->
    <ng-container matColumnDef="measurementGroup">
      <th mat-header-cell
          *matHeaderCellDef>
        Наименование испытуемых групп объектов
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.measurementGroup || '—' }}
      </td>
    </ng-container>

    <!-- Место установки / хранения -->
    <ng-container matColumnDef="location">
      <th mat-header-cell
          [matTooltip]="'Место установки или хранения'"
          *matHeaderCellDef>
        Место установки
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        {{ item.location || '—' }}
      </td>
    </ng-container>

    <!-- Основные технические характеристики -->
    <ng-container matColumnDef="characteristics">
      <th mat-header-cell
          [matTooltip]="'Основные технические характеристики оборудования'"
          *matHeaderCellDef>
        Технические характеристики
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        @if (item?.characteristics && Array.isArray(item.characteristics)) {
          @if (item.characteristics.length > 0) {
            <div class="characteristics-list">
              @for (char of item.characteristics; track $index) {
                <div class="characteristic-item">
                  <strong>{{ char.name }}</strong>:
                  {{ char.value }} {{ char.unit || '' }}
                </div>
              }
            </div>
          } @else {
            <span>—</span>
          }
        } @else {
          <span>—</span>
        }
      </td>
    </ng-container>
    <!-- Аттестация -->
    <ng-container matColumnDef="attestation">
      <th mat-header-cell
          [matTooltip]="'Дата и номер документа об аттестации, срок его действия'"
          *matHeaderCellDef>
        Аттестация
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        @if (getLastAttestation(item.attestations); as last) {
          @if (last.isSuccess) {
            <div class="attestation-item">
              <div><strong>№:</strong> {{ last.attestationNumber }}</div>
              <div><strong>Дата аттестации:</strong> {{ last.startAt | date }}</div>
              <div><strong>Действ. до:</strong> {{ last.endAt | date }}</div>
            </div>
          } @else {
            <div><strong>№:</strong> {{ last.attestationNumber }}</div>
            <div>
              <strong>Статус:</strong>
              <span [class.active]="last.isSuccess" [class.expired]="!last.isSuccess">
                        {{ 'Неудовлетворительная' }}
                      </span>
            </div>
          }
        } @else {
          <span>—</span>
        }
      </td>
    </ng-container>

    <!-- Право владения -->
    <ng-container matColumnDef="ownership">
      <th mat-header-cell
          [matTooltip]="'Право собственности или иное законное основание, предусматривающее право владения и пользования (реквизиты подтверждающих документов)'"
          *matHeaderCellDef>
        Право владения
      </th>
      <td mat-cell *matCellDef="let item" class="data-cell">
        @if (item.contract; as c) {
          <div class="contract-info">
            <div><strong>Тип:</strong> {{ c.isOwn ? 'Собственность' : 'Аренда' }}</div>
            @if (c.contractNumber) {
              <div><strong>Договор:</strong> №{{ c.contractNumber }}</div>
            }
            @if (c.contractDate) {
              <div><strong>От:</strong> {{ c.contractDate | date }}</div>
            }
            @if (!c.isOwn && c.contractDate && c.endAt) {
              <div><strong>Срок:</strong> {{ c.contractDate | date }} — {{ c.endAt | date }}</div>
            }
          </div>
        } @else {
          <span>—</span>
        }
      </td>
    </ng-container>

    <!-- Действия -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Действия</th>
      <td mat-cell *matCellDef="let item">
        <button
          mat-icon-button
          [matTooltip]="'Редактировать'"
          (click)="openDialog(TestEquipmentDialog, 'test-equipments', Mode.EDIT, item)">
          <mat-icon>edit</mat-icon>
        </button>
        <button
          mat-icon-button
          [matTooltip]="'Удалить'"
          (click)="delete(item.id, 'test-equipments')">
          <mat-icon>delete</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
} @else if (viewMode == 'attestation-chart') {
  <app-test-equipment-attestation [info]="info()"></app-test-equipment-attestation>
} @else if (viewMode == 'maintenance-chart') {
  <app-test-equipment-maintenance [info]="info()"></app-test-equipment-maintenance>
}





