<!-- Заголовок и кнопка добавления -->
<div>
  <h2>Вспомогательное оборудование</h2>
</div>

<div class="table-actions">
    <button mat-button [matMenuTriggerFor]="columnMenu">
      <mat-icon>view_column</mat-icon>
      Колонки
    </button>
    <mat-menu #columnMenu="matMenu">
      @for (col of getAllColumns(); track col) {
        @if (col !== 'index' && col !== 'actions') {
          <button mat-menu-item>
            <mat-checkbox
              [checked]="displayedColumns.includes(col)"
              (change)="toggleColumn(col, $event)">
              {{ getColumnLabel(col) }}
            </mat-checkbox>
          </button>
        }
      }
    </mat-menu>

  <button
    (click)="openDialog(AdditionalEquipmentDialog, Mode.CREATE)"
    [matTooltip]="'Добавить оборудование'"
    class="table-add-button">
    <mat-icon>add</mat-icon>
  </button>
</div>

<!-- Таблица -->
<table mat-table [dataSource]="info()" class="mat-elevation-z8">

  <!-- № п/п -->
  <ng-container matColumnDef="index">
    <th mat-header-cell *matHeaderCellDef>№</th>
    <td mat-cell *matCellDef="let _; let i = index" class="data-cell">
      {{ i + 1 }}
    </td>
  </ng-container>

  <!-- Наименование -->
  <ng-container matColumnDef="name">
    <th mat-header-cell [matTooltip]="'Наименование оборудования'" *matHeaderCellDef>
      Наименование
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.name || '—' }}
    </td>
  </ng-container>

  <!-- Изготовитель -->
  <ng-container matColumnDef="producer">
    <th mat-header-cell
        [matTooltip]="'Страна, наименование организации, год выпуска'"
        *matHeaderCellDef>
      Изготовитель
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      @if (item.producer || item.produceYear) {
        <div>
          <div>{{ item.producer || '—' }}</div>
          @if (item.produceYear) {
            <small>Год выпуска: {{ item.produceYear }}</small>
          }
        </div>
      } @else {
        <span>—</span>
      }
    </td>
  </ng-container>

  <!-- Год ввода в эксплуатацию -->
  <ng-container matColumnDef="yearOfCommissioning">
    <th mat-header-cell
        *matHeaderCellDef>
      Год ввода в эксплуатацию
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.yearOfCommissioning || '—' }}
    </td>
  </ng-container>

  <!-- Номера (заводской / инвентарный) -->
  <ng-container matColumnDef="numbers">
    <th mat-header-cell
        [matTooltip]="'Заводской номер (при наличии), инвентарный номер или другая уникальная идентификация'"
        *matHeaderCellDef>
      Уникальная идентификация
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      <div>
        @if (item.produceNumber) {
          <div>Заводской: {{ item.produceNumber }}</div>
        }
        @if (item.uniqueNumber) {
          <div>Инвентарный: {{ item.uniqueNumber }}</div>
        }
        @if (!item.produceNumber && !item.uniqueNumber) {
          <span>—</span>
        }
      </div>
    </td>
  </ng-container>

  <!-- Назначение -->
  <ng-container matColumnDef="purpose">
    <th mat-header-cell
        *matHeaderCellDef>
      Назначение
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.purpose || '—' }}
    </td>
  </ng-container>

  <!-- Место установки / хранения -->
  <ng-container matColumnDef="location">
    <th mat-header-cell
        [matTooltip]="'Место установки или хранения'"
        *matHeaderCellDef>
      Место установки
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      {{ item.location || '—' }}
    </td>
  </ng-container>

  <!-- Право владения -->
  <ng-container matColumnDef="ownership">
    <th mat-header-cell
        [matTooltip]="'Право собственности или иное законное основание, предусматривающее право владения и пользования (реквизиты подтверждающих документов)'"
        *matHeaderCellDef>
      Право владения
    </th>
    <td mat-cell *matCellDef="let item" class="data-cell">
      @if (item.contract; as c) {
        <div class="contract-info">
          <div><strong>Тип:</strong> {{ c.isOwn ? 'Собственность' : 'Аренда' }}</div>
          @if (c.contractNumber) {
            <div><strong>Договор:</strong> №{{ c.contractNumber }}</div>
          }
          @if (c.contractDate) {
            <div><strong>От:</strong> {{ c.contractDate | date }}</div>
          }
          @if (!c.isOwn && c.contractDate && c.endAt) {
            <div><strong>Срок:</strong> {{ c.contractDate | date }} — {{ c.endAt | date }}</div>
          }
        </div>
      } @else {
        <span>—</span>
      }
    </td>
  </ng-container>

  <!-- Действия -->
  <ng-container matColumnDef="actions">
    <th mat-header-cell *matHeaderCellDef>Действия</th>
    <td mat-cell *matCellDef="let item">
      <button
        mat-icon-button
        [matTooltip]="'Редактировать'"
        (click)="openDialog(AdditionalEquipmentDialog, Mode.EDIT, item)">
        <mat-icon>edit</mat-icon>
      </button>
      <button
        mat-icon-button
        [matTooltip]="'Удалить'"
        (click)="delete(item.id)">
        <mat-icon>delete</mat-icon>
      </button>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
</table>
